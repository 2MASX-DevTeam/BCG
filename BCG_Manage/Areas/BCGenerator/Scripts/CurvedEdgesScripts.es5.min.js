"use strict";function getMousePosition(n){var t=gCanvas.getBoundingClientRect(),i=n.clientX-t.left,r=n.clientY-t.top;return console.log(i+"   "+r),new Point(i,r)}function handleDown(n){var t=getMousePosition(n);switch(gState){case Mode.kAdding:handleDownAdd(t);break;case Mode.kSelecting:handleDownSelect(t);break;case Mode.kRemoving:handleDownRemove(t)}}function handleDownAdd(n){if(gBezierPath){if(handleDownSelect(n))return;gBezierPath.addPoint(n)}else gBezierPath=new BezierPath(n);render()}function handleDownSelect(n){if(!gBezierPath)return!1;var t=gBezierPath.selectPoint(n);return t?(gState=Mode.kDragging,gCanvas.addEventListener("mousemove",updateSelected,!1),!0):!1}function handleDownRemove(n){if(gBezierPath){var t=gBezierPath.deletePoint(n);t&&render()}}function updateSelected(n){var t=getMousePosition(n);gBezierPath.updateSelected(t);render()}function handleUp(){gState==Mode.kDragging&&(gCanvas.removeEventListener("mousemove",updateSelected,!1),gBezierPath.clearSelected(),gState=Mode.kSelecting)}function render(){if(gBackCtx.clearRect(0,0,WIDTH,HEIGHT),gCtx.clearRect(0,0,WIDTH,HEIGHT),gBackgroundImg&&gBackCtx.drawImage(gBackgroundImg,0,0),gBezierPath){gBezierPath.draw(gBackCtx);var n=document.getElementById("putJS");n.innerHTML=gBezierPath.toJSString()}gCtx.drawImage(gBackCanvas,0,0)}function Point(n,t){var e=this,i=n,r=t,u=3,f=u+2;this.x=function(){return i};this.y=function(){return r};this.set=function(n,t){i=n;r=t};this.drawSquare=function(n){n.fillRect(i-u,r-u,u*2,u*2)};this.computeSlope=function(n){return(n.y()-r)/(n.x()-i)};this.contains=function(n){var t=n.x()>=i-f&&n.x()<=i+f,u=n.y()>=r-f&&n.y()<=r+f;return t&&u};this.offsetFrom=function(n){return{xDelta:n.x()-i,yDelta:n.y()-r}};this.translate=function(n,t){i+=n;r+=t}}function ControlPoint(n,t,i,r){function c(n,t){o=Math.sqrt(Math.pow(n,2)+Math.pow(t,2));var i=Math.atan(t/n);isNaN(i)||(f=i,n<0&&(f+=Math.PI))}function h(){var n=null;s&&e.prev?n=e.prev.ctrlPt2:!s&&e.next&&(n=e.next.ctrlPt1);n&&n.setAngle(f+Math.PI)}var u=this,f=n,o=t,e=i,s=r;this.setAngle=function(n){f!=n&&(f=n)};this.origin=function(){var n=null;return(n=s?e.prev:e,n)?new Point(n.pt.x(),n.pt.y()):null};this.asPoint=function(){return new Point(u.x(),u.y())};this.x=function(){return u.origin().x()+u.xDelta()};this.y=function(){return u.origin().y()+u.yDelta()};this.xDelta=function(){return o*Math.cos(f)};this.yDelta=function(){return o*Math.sin(f)};this.translate=function(n,t){var r=u.asPoint(),i;r.translate(n,t);i=u.origin().offsetFrom(r);c(i.xDelta,i.yDelta);u.__proto__.syncNeighbor&&h()};this.contains=function(n){return u.asPoint().contains(n)};this.offsetFrom=function(n){return u.asPoint().offsetFrom(n)};this.draw=function(n){n.save();n.fillStyle="gray";n.strokeStyle="gray";n.beginPath();var i=u.origin(),t=u.asPoint();n.moveTo(i.x(),i.y());n.lineTo(t.x(),t.y());n.stroke();t.drawSquare(n);n.restore()};u.__proto__.syncNeighbor&&h()}function LineSegment(n,t){function r(n,t,i,r,u){n.save();n.fillStyle="black";n.strokeStyle="black";n.beginPath();n.moveTo(t.x(),t.y());n.bezierCurveTo(r.x(),r.y(),u.x(),u.y(),i.x(),i.y());n.stroke();n.restore()}function u(){if(i.pt=n,i.prev=t,i.prev){var u=i.pt.computeSlope(i.prev.pt),r=Math.atan(u);i.prev.pt.x()>i.pt.x()&&(r*=-1);i.ctrlPt1=new ControlPoint(r+Math.PI,15,i,!0);i.ctrlPt2=new ControlPoint(r,15,i,!1)}}var i=this;this.pt;this.ctrlPt1;this.ctrlPt2;this.next;this.prev;this.selectedPoint;u();this.draw=function(n){i.pt.drawSquare(n);i.ctrlPt1&&i.ctrlPt1.draw(n);i.ctrlPt2&&i.ctrlPt2.draw(n);i.prev&&r(n,i.prev.pt,i.pt,i.ctrlPt1,i.ctrlPt2)};this.toJSString=function(){if(i.prev){var n=0,t=0,r=0,u=0,f=0;return i.ctrlPt1&&(n=Math.round(i.ctrlPt1.x()),t=Math.round(i.ctrlPt1.y())),i.ctrlPt2&&(r=Math.round(i.ctrlPt2.x()),ctrlPt2y=Math.round(i.ctrlPt2.y())),i.pt&&(u=Math.round(i.pt.x()),f=Math.round(i.pt.y())),"  ctx.bezierCurveTo("+n+" + xoff, "+t+" + yoff, "+r+" + xoff, "+ctrlPt2y+" + yoff, "+u+" + xoff, "+f+" + yoff);"}return"  ctx.moveTo("+Math.round(i.pt.x())+" + xoff, "+Math.round(i.pt.y())+" + yoff);"};this.findInLineSegment=function(n){return i.pathPointIntersects(n)?(i.selectedPoint=i.pt,!0):i.ctrlPt1&&i.ctrlPt1.contains(n)?(i.selectedPoint=i.ctrlPt1,!0):i.ctrlPt2&&i.ctrlPt2.contains(n)?(i.selectedPoint=i.ctrlPt2,!0):!1};this.pathPointIntersects=function(n){return i.pt&&i.pt.contains(n)};this.moveTo=function(n){var t=i.selectedPoint.offsetFrom(n);i.selectedPoint.translate(t.xDelta,t.yDelta)}}function BezierPath(n){function r(){t.addPoint(n)}var t=this,i;this.head=null;this.tail=null;this.addPoint=function(n){var i=new LineSegment(n,t.tail);return t.tail==null?(t.tail=i,t.head=i):(t.tail.next=i,t.tail=t.tail.next),i};r();this.draw=function(n){if(t.head!=null)for(var i=t.head;i!=null;)i.draw(n),i=i.next};this.selectPoint=function(n){for(var r=t.head;r!=null;){if(r.findInLineSegment(n))return i=r,!0;r=r.next}return!1};this.deletePoint=function(n){for(var i=t.head;i!=null;){if(i.pathPointIntersects(n)){var f=i,u=i.prev,r=i.next;return u&&r?(u.next=r,r.prev=u):u?r||(t.tail=u,t.tail?t.tail.next=null:t.head=null):(t.head=r,t.head?(r.ctrlPt1=null,r.ctrlPt2=null,t.head.prev=null):t.tail=null),!0}i=i.next}return!1};this.clearSelected=function(){i=null};this.updateSelected=function(n){i.moveTo(n)};this.toJSString=function(){for(var n=["function drawShape(ctx, xoff, yoff) {","  ctx.beginPath();"],i=t.head;i!=null;)n.push(i.toJSString()),i=i.next;return n.push("  ctx.stroke();"),n.push("}"),n.join("\n")}}var gCanvas,gCtx,gBackCanvas,gBackCtx,gBezierPath,Mode={kAdding:{value:0,name:"Adding"},kSelecting:{value:1,name:"Selecting"},kDragging:{value:2,name:"Dragging"},kRemoving:{value:3,name:"Removing"}},gState,gBackgroundImg,WIDTH,HEIGHT;window.onload=function(){var t,i,r,n,u,f;gCanvas=document.getElementById("paintme");gCtx=gCanvas.getContext("2d");HEIGHT=gCanvas.height;WIDTH=gCanvas.width;console.log(HEIGHT+"  "+WIDTH);gBackCanvas=document.createElement("canvas");gBackCanvas.height=HEIGHT;gBackCanvas.width=WIDTH;gBackCtx=gBackCanvas.getContext("2d");gState=Mode.kAdding;gCanvas.addEventListener("mousedown",handleDown,!1);gCanvas.addEventListener("mouseup",handleUp,!1);t=document.getElementById("selectMode");t.addEventListener("click",function(){gState=Mode.kSelecting},!1);i=document.getElementById("addMode");i.addEventListener("click",function(){gState=Mode.kAdding},!1);r=document.getElementById("removeMode");r.addEventListener("click",function(){gState=Mode.kRemoving},!1);n=document.getElementById("lockControl");n.addEventListener("click",function(){ControlPoint.prototype.syncNeighbor=n.checked},!1);u=document.getElementById("clear");u.addEventListener("click",function(){var n=confirm("r u sure u want to delete all");n&&(gBezierPath=null,gBackCtx.clearRect(0,0,WIDTH,HEIGHT),gCtx.clearRect(0,0,WIDTH,HEIGHT))},!1);f=document.getElementById("addImgSrc");f.addEventListener("click",function(){var n=document.getElementById("imageSrc");gBackgroundImg=document.createElement("img");gBackgroundImg.onerror=function(){gBackgroundImg=null};gBackgroundImg.src=n.value;render();n.value=""},!1)};ControlPoint.prototype.syncNeighbor=!0;